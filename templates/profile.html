<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ username | capitalize }}'s Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root {
         --bs-primary: rgba(0,43,83,1);
    --bs-primary-rgb: 0,43,83;
              --brand-color: rgba(0,43,83,1);
      --brand-hover: #001d3d;
      --found-color: rgba(172,212,241,1);
      --returned-color: rgba(165,179,171,1);
      --brand-color: rgba(0,43,83,1);
      --brand-hover: #001d3d;
      --found-color: rgba(172,212,241,1);
      --returned-color: rgba(165,179,171,1);
    }
  .text-primary {
    color: rgba(0,43,83,1) !important;
  }
    body {
      background: #f7f9fc;
      font-family: 'Segoe UI', sans-serif;
    }

body {
  position: relative;
  background-color: #f7f9fc;
  font-family: "Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS", sans-serif;
}

body::before {
  content: "";
  position: absolute;
  top: 15%;
  left: 50%;
  width: 850px;
  height: 850px;
  background: url('{{ url_for("static", filename="dolphin_logo.webp") }}') no-repeat center center;
  background-size: contain;
  opacity: 0.025;
  transform: translateX(-50%);
  z-index: 1;
  pointer-events: none;
}



h1, h2, h3, h4, h5, h6 {
  font-family: "Minion Pro", "Georgia", serif;
}
    .section-title {
      border-left: 4px solid var(--brand-color);
      padding-left: 12px;
      margin-bottom: 1rem;
      font-weight: 600;
      color: var(--brand-color);
    }

    .card {
      border: none;
      border-radius: 0.75rem;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      z-index:2;
      transition: transform 0.2s ease;
    }

    .card:hover {
      transform: translateY(-4px);
    }

    .card-img-top {
      height: 180px;
      object-fit: cover;
    }

    .badge-status {
      font-size: 0.75rem;
      padding: 0.4em 0.7em;
      border-radius: 0.5rem;
    }

    .badge-returned {
      background-color: var(--returned-color);
      color: white;
    }

    .badge-pending {
      background-color: #ffc107;
      color: #000;
    }

    .btn-mark {
      border-color: var(--brand-color);
      color: var(--brand-color);
    }

    .btn-mark:hover {
      background-color: var(--brand-color);
      color: white;
    }

    .btn-back {
      background-color: #e0e0e0;
      border: none;
      font-weight: 500;
    }

    .btn-back:hover {
      background-color: #d0d0d0;
    }
    .card {
  border-radius: 1rem;
  transition: all 0.2s ease;
}

.card:hover {
  transform: scale(1.01);
}

.badge-status {
  font-size: 0.8rem;
  padding: 0.4em 0.8em;
  border-radius: 0.5rem;
}
.profile-card{
  text-align:center;
}
.profile-card .bi-stars {
  vertical-align: middle;
}
      .btn-primary {
    background-color: rgba(0,43,83,1) !important;
    border-color: rgba(0,43,83,1) !important;
  }

  .btn-primary:hover {
    background-color: #001d3d !important;
    border-color: #001d3d !important;
  }
    .bg-info{
      background-color:rgba(172,212,241,1) !important;
    }
    .leaderboard-btn {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 56px;
  height: 56px;
  font-size: 1.25rem;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1055;
}

.bg-warning-subtle {
  background-color: #fff9db !important;
}
.bg-secondary-subtle {
  background-color: #eaeaea !important;
}
.bg-bronze-subtle {
  background-color: #fbe4d5 !important;
}

.border-bronze {
  border-color: #cd7f32 !important;
}

.leaderboard-entry {
  transition: all 0.2s ease-in-out;
}

.leaderboard-entry:hover {
  transform: scale(1.01);
  background-color: rgba(0, 43, 83, 0.05);
}
    .bg-lost {
  background-color: rgba(217, 84, 30) !important;
  color: white !important;
}

.bg-returned {
  background-color: rgba(172,212,241,1) !important;
  color: white !important;
}
    .bg-success {
  background-color: rgba(0,43,83,1) !important;
}
        .btn-success{
        background-color: rgba(0,43,83,1) !important;
    }

  </style>
</head>
<body>
  {% include 'nav.html' %}

  <div class="container py-4">
    <div class="text-center mb-5">
<!--      <h2 class="fw-bold mt-4">{{ username | capitalize }}'s Profile</h2>-->
<!--      <p class="text-muted mb-0">Points: <span class="fw-bold" style="color: var(&#45;&#45;brand-color)">{{ points }}</span></p>-->
    </div>
<div class="row g-5 mt-5">
  <!-- Left Column: Profile Card -->
<div class="col-lg-3 mb-4">
  <div class="position-sticky" style="top: 120px;">
<div class="card profile-card border-0 p-4 position-relative">
  <!-- Absolute edit icon in the card corner -->
  <button
    class="btn position-absolute top-0 end-0 m-2 p-1 text-muted"
    style="border: none; background: transparent;"
    data-bs-toggle="modal"
    data-bs-target="#editProfileModal"
    title="Edit Profile"
  >
    <i class="bi bi-pencil-square fs-5"></i>
  </button>

  <div class="card-body">
    <div class="d-flex justify-content-center align-items-center">
      <div>
        <h3 class="fw-bold mb-2 text-dark">{{ username | capitalize }}</h3>
        <p class="mb-2">
          <strong>Email:</strong>
          <span id="email" class="text-muted">{{ user.get('email') }}</span>
        </p>
        <div class="d-flex flex-wrap gap-2 mt-3 mb-2">
          {% if user.get('role') %}
          <span class="badge bg-info text-dark px-3 py-2" id="role">{{ user.get('role', '').capitalize() }}</span>
          {% endif %}
          {% if user.get('grade') %}
          <span class="badge bg-secondary px-3 py-2" id="grade">{{ user.get('grade', '') }} Grade</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

  </div>
</div>


  <!-- Right Column: Items and Messages -->
  <div class="col-lg-9">
    <!-- Lost Items Section -->
    <h5 class="section-title">Your Lost Items</h5>
    <div class="row mb-5">
      {% if lost_items %}
        {% for item in lost_items %}
        <div class="col-md-4 mb-4">
<div class="card item-card position-relative">
            <button type="button"
        class="btn btn-sm position-absolute top-0 end-0 m-2 text-secondary"
        style="background: rgba(255,255,255,0.85); z-index: 10;"
        data-bs-toggle="modal"
        data-bs-target="#editItemModal{{ loop.index }}"
        title="Edit Item">
  <i class="bi bi-pencil-square"></i>
</button>
            <img src="{{ url_for('static', filename='uploads/' + (item.image if item.image else 'placeholder.jpg')) }}"
                 class="card-img-top"
                 onerror="this.onerror=null;this.src='https://via.placeholder.com/400x250?text=No+Image';"
                 alt="Item Image">
            <div class="card-body">
              <h5 class="card-title">{{ item.title }}</h5>
<p class="card-text text-muted">{{ item.description[:30] }}{% if item.description|length > 30 %}...{% endif %}</p>
              <div class="d-flex justify-content-between align-items-center">
<span class="badge
  {% if item.status == 'returned' %}bg-returned
  {% elif item.status == 'pending' %}bg-warning
   {% elif item.status == 'found' %}bg-primary
  {% else %}bg-lost{% endif %}">
  {% if item.status == 'returned' %}
    <i class="bi bi-check-circle-fill me-1"></i>Returned
  {% elif item.status == 'pending' %}
    <i class="bi bi-hourglass me-1"></i>Pending
    {% elif item.status == 'found' %}
    <i class="bi bi-bell"></i> Found
  {% else %}
    <i class="bi bi-question-circle-fill me-1"></i>Lost
  {% endif %}
</span>

                {% if not item.returned %}
                <form method="POST" action="{{ url_for('mark_returned_from_profile') }}">
                  <input type="hidden" name="title" value="{{ item.title }}">
                  <button type="submit" class="btn btn-sm btn-mark">Mark as Found</button>
                </form>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      <div class="modal fade" id="editItemModal{{ loop.index }}" tabindex="-1" aria-labelledby="editItemModalLabel{{ loop.index }}" aria-hidden="true">
  <div class="modal-dialog">
<form method="POST" action="{{ url_for('edit_item', item_id=item.key) }}" enctype="multipart/form-data" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editItemModalLabel{{ loop.index }}">Edit {{ item.title }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" name="item_key" value="{{ item.key }}">
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input type="text" name="title" class="form-control" value="{{ item.title }}" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea name="description" class="form-control" rows="3" required>{{ item.description }}</textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Lost Date</label>
          <input type="date" name="lost_date" class="form-control" value="{{ item.lost_date }}">
        </div>
        <div class="mb-3">
          <label class="form-label">Change Image</label>
          <input type="file" name="image" class="form-control">
          <img src="{{ url_for('static', filename='uploads/' + item.image) }}" class="img-fluid mt-2" style="max-height: 120px;">
        </div>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </div>
    </form>
  </div>
</div>
        {% endfor %}
      {% else %}
        <p class="text-muted">No lost items reported yet.</p>
      {% endif %}
    </div>

    <!-- Returned Items Section -->
    <h5 class="section-title">Your Returned Items</h5>
    <div class="row">
      {% if returned_items %}
        {% for item in returned_items %}
        <div class="col-md-4 mb-4">
          <div class="card item-card border border-light">
            <img src="{{ url_for('static', filename='uploads/' + (item.image if item.image else 'placeholder.jpg')) }}"
                 class="card-img-top"
                 onerror="this.onerror=null;this.src='https://via.placeholder.com/400x250?text=No+Image';"
                 alt="Item Image">
            <div class="card-body">
              <h5 class="card-title">{{ item.title }}</h5>
<p class="card-text text-muted">{{ item.description[:30] }}{% if item.description|length > 30 %}...{% endif %}</p>
              <span class="badge-status badge-returned">Returned</span>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="text-muted">No returned items yet.</p>
      {% endif %}
    </div>

    <!-- Messages Section -->
    <h5 class="section-title mt-5">Messages You Received</h5>
    <div class="row">
      {% if received_messages %}
        {% for msg in received_messages %}
        <div class="col-md-4 mb-4">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <h6 class="fw-bold mb-2 text-primary">Someone found: "{{ msg.item }}"</h6>
              <p class="mb-1"><span style="font-weight:600;">Name:</span> {{ msg.finder_name }}</p>
              <p class="mb-1"><span style="font-weight:600;">Grade:</span> {{ msg.finder_grade }}</p>
              <p class="mb-1"><span style="font-weight:600;">Contact:</span> {{ msg.finder_contact }}</p>
              <p class="mb-2"><span style="font-weight:600;">Message:</span> <br>{{ msg.message }}</p>
<!--              <span class="badge {{ 'bg-success' if msg.seen else 'bg-secondary' }}">-->
<!--                {{ 'Seen' if msg.seen else 'New' }}-->
<!--              </span>-->
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="text-muted">No one has contacted you about your items yet.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Back Button -->
<div class="text-center mt-5">
  <a href="{{ url_for('logout') }}" class="btn btn-back px-4 py-2">Logout</a>
</div>

    <!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editProfileForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-control" value="{{ user.email }}">
          </div>

          <div class="mb-3">
            <label class="form-label">Grade</label>
            <select name="grade" class="form-select">
              {% for g in range(1, 13) %}
              <option value="{{ g }}" {% if user.grade == g|string %}selected{% endif %}>{{ g }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Role</label>
            <select name="role" class="form-select">
              <option value="student" {% if user.role == 'student' %}selected{% endif %}>Student</option>
              <option value="teacher" {% if user.role == 'teacher' %}selected{% endif %}>Teacher</option>
            </select>
          </div>
        </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </div>
    </form>
  </div>
</div>

  <!-- Floating Leaderboard Button -->
<!--<button class="btn btn-primary shadow-lg rounded-circle leaderboard-btn" data-bs-toggle="modal" data-bs-target="#leaderboardModal" title="View Leaderboard">-->
<!--  <i class="bi bi-trophy-fill fs-4"></i>-->
<!--</button>-->

<!-- Leaderboard Modal -->
<div class="modal fade" id="leaderboardModal" tabindex="-1" aria-labelledby="leaderboardModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="leaderboardModalLabel"><i class="bi bi-trophy-fill me-2"></i>Points Leaderboard</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body px-4 pt-3 pb-4">
        {% for user, data in sorted_users %}
          <div class="d-flex justify-content-between align-items-center px-3 py-2 mb-2 rounded shadow-sm leaderboard-entry
                      border-start border-5
                      {% if loop.index == 1 %}bg-warning-subtle border-warning fw-bold
                      {% elif loop.index == 2 %}bg-secondary-subtle border-secondary fw-semibold
                      {% elif loop.index == 3 %}bg-bronze-subtle border-bronze fw-medium
                      {% else %}bg-white border-light-subtle{% endif %}">
            <div class="d-flex align-items-center gap-3">
              <span class="fs-5 fw-bold text-muted">#{{ loop.index }}</span>
              <span class="fs-6">{{ user }}</span>
            </div>
            <span class="badge bg-primary rounded-pill px-3">{{ data.points }} pts</span>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="returnSuccessModal" tabindex="-1" aria-labelledby="returnSuccessModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="returnSuccessModalLabel">Congratulations!</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <p class="mb-0">Your item was successfully marked as returned!</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-success px-4" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>
    <!-- Edit Item Modal -->



    <script>
document.getElementById('editProfileForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const formData = new FormData(this);
  const data = {
    email: formData.get('email'),
    grade: formData.get('grade'),
    role: formData.get('role')
  };

  fetch('/api/update_profile', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
      document.getElementById('email').textContent = data.email;
      document.getElementById('grade').textContent = data.grade + ' Grade';
      document.getElementById('role').textContent = data.role.charAt(0).toUpperCase() + data.role.slice(1);
      bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
    } else {
      alert('Update failed: ' + result.error);
    }
  })
  .catch(err => {
    console.error('Error:', err);
    alert('Something went wrong.');
  });
});
</script>
{% with messages = get_flashed_messages() %}
  {% if messages %}
    <script>
      window.addEventListener('load', function () {
        const msg = {{ messages[0] | tojson }};
        if (msg.includes("marked as returned")) {
          const modal = new bootstrap.Modal(document.getElementById('returnSuccessModal'));
          modal.show();
        }
      });
    </script>
  {% endif %}
{% endwith %}
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
      alert("Your item report has been successfully submitted!");
    }
  });
</script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
